<!DOCTYPE html>
<html lang="en">



<head>
    <meta charset="UTF-8">
    <title>contour</title>
    <style>
        #map {
            height: 100%;
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <canvas width="960" height="500"></canvas>

</body>
<script src="lib/jqure1.7.min.js"></script>
<script src="lib/d3.v4.min.js"></script>
<script src="lib/d3-contour.v1.min.js"></script>
<script src="lib/dat.gui.min.js"></script>
<script src="lib/openlayer/ol-debug.js"></script>
<script src="js/contour2.js"></script>
<script>


    let baseLayer = new ol.layer.Tile({
        title: "base",
        source: new ol.source.OSM()
    });
    var olMap = new ol.Map({
        target: 'map',
        layers: [baseLayer],
        view: new ol.View({
            center: [115.79, 36.142],
            projection: 'EPSG:4326',
            zoom: 8
        })
    });

    olMap.on('click', (evt) => {
        console.log(evt)
        const px = olMap.getPixelFromCoordinate(evt.coordinate);
        AjaxGET()
    })

    var canvasLayer = null;

    //移除已有图层
    if (canvasLayer !== null) {
        olMap.removeLayer(canvasLayer);
    }
    //创建新图层
    canvasLayer = new ol.layer.Image({
        source: new ol.source.ImageCanvas({
            canvasFunction: (extent, resolution, pixelRatio, size, projection) => {
                console.log(extent);
                let canvas = document.createElement('canvas');
                canvas.width = size[0];
                canvas.height = size[1];
                canvas.style.display = 'block';
                //设置canvas透明度
                canvas.getContext('2d').globalAlpha = 0.4;
                context = canvas.getContext('2d');
                width = size[0];
                height = size[1]
                //使用分层设色渲染
                // kriging.plot(canvas, grid,
                //     [extent[0], extent[2]], [extent[1], extent[3]], params.colors);
                co = new Psdb.Contour(context, width, height);
                return canvas;
            },
            projection: 'EPSG:4326'
        })
    })
    //向map添加图层
    olMap.addLayer(canvasLayer);

    function AjaxGET() {
        $.ajax({
            type: "get",
            url: "../data/getLatest.json",
            dataType: "json",
            success: function (json) {
                console.log(json)
                var _data = json.data;
                var _target = []
                for (var i = 0; i < _data.length; i++) {
                    // var coord = new ol.Coordinate([_data[i].lon, _data[i].lat])
                    var px = olMap.getPixelFromCoordinate([_data[i].lon, _data[i].lat]);
                    _target.push({
                        x: px[0],
                        y: px[1],
                        value: _data[i].AQI
                    })
                }
                console.log(_target)
                co.initMap(mode, _target);
            }
        });
    }


    // var canvas = document.querySelector("canvas"),
    //     width = 960,
    //     height = 500,
    //     context = canvas.getContext("2d");

    var context = null

    var mode = {};

    mode.mapType = 'heatmap';
    mode.heatmap_line = false;
    mode.contour_isfull = false;
    mode.drawpoint = false;
    mode.drawlable = false;
    mode.referenceValue = 85;
    mode.mapAlpha = 0.4;
    mode.mapThresholds = 10;


    // var co = new Psdb.Contour(context, width, height);

    // GUI
    var gui = new dat.GUI();

    // 下拉框形式选择文案
    gui.add(mode, 'mapType', ['heatmap', 'contour']).onChange(function () {
        co.refreshMap(mode);
    });

    gui.add(mode, 'heatmap_line').onChange(function () {
        co.refreshMap(mode);
    });
    gui.add(mode, 'contour_isfull').onChange(function () {
        co.refreshMap(mode);
    });

    gui.add(mode, 'drawpoint').onChange(function () {
        co.refreshMap(mode);
    });
    gui.add(mode, 'drawlable').onChange(function () {
        co.refreshMap(mode);
    });

    gui.add(mode, 'referenceValue', 70, 100).onChange(function () {
        co.refreshMap(mode);
    });
    gui.add(mode, 'mapAlpha', 0.1, 1.0).onChange(function () {
        co.refreshMap(mode);
    });
    gui.add(mode, 'mapThresholds', 5, 20).onChange(function () {
        co.refreshMap(mode);
    });


    // //生成随机数据
    // var data = [];
    // for (var i = 0; i < 30; i++) {
    //     data.push({
    //         x: Math.round(Math.abs(d3.randomNormal(0, width)())),
    //         y: Math.round(Math.abs(d3.randomNormal(0, height)())),
    //         value: Math.random() * 10
    //     });
    // };
    // console.log(data)
    // co.initMap(mode, data);



</script>

</html>